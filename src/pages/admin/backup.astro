---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { readdir, stat } from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
// Resolver caminho do projeto (src/pages/admin -> raiz do projeto)
const projectRoot = path.resolve(__dirname, '..', '..', '..');

// Listar backups existentes
let backups = [];
try {
  const backupsDir = path.join(projectRoot, 'backups');
  const files = await readdir(backupsDir);
  
  backups = await Promise.all(
    files
      .filter(file => file.endsWith('.zip'))
      .map(async (file) => {
        const filePath = path.join(backupsDir, file);
        const stats = await stat(filePath);
        return {
          name: file,
          size: stats.size,
          date: stats.mtime,
        };
      })
  );
  
  // Ordenar por data (mais recente primeiro)
  backups.sort((a, b) => b.date.getTime() - a.date.getTime());
} catch (error) {
  // Pasta backups não existe ainda
  backups = [];
}

const formatFileSize = (bytes: number) => {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
  return (bytes / 1024 / 1024).toFixed(2) + ' MB';
};

const formatDate = (date: Date) => {
  return date.toLocaleString('pt-BR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
};

const getBackupComponents = (fileName: string) => {
  if (fileName.includes('-all.zip')) return ['Banco de Dados', 'Imagens', 'Código'];
  const components = [];
  if (fileName.includes('-db-')) components.push('Banco de Dados');
  if (fileName.includes('-storage-')) components.push('Imagens');
  if (fileName.includes('-code')) components.push('Código');
  return components.length > 0 ? components : ['Todos'];
};
---

<AdminLayout title="Backup">
  <div class="backup-page">
    <header class="page-header">
      <h1>Sistema de Backup</h1>
      <p>Gere backups do banco de dados, imagens do storage e código do projeto</p>
    </header>

    <!-- Backup Options -->
    <div class="section">
      <h2>Gerar Novo Backup</h2>
      <div class="backup-card">
        <form id="backupForm" method="POST" action="/api/backup">
          <div class="backup-options">
            <label class="checkbox-option">
              <input type="checkbox" name="database" id="checkDatabase" value="1" />
              <div class="checkbox-content">
                <span class="checkbox-label">Banco de Dados</span>
                <span class="checkbox-description">Exporta produtos, categorias, configurações e imagens (JSON)</span>
              </div>
            </label>

            <label class="checkbox-option">
              <input type="checkbox" name="storage" id="checkStorage" value="1" />
              <div class="checkbox-content">
                <span class="checkbox-label">Imagens do Storage</span>
                <span class="checkbox-description">Baixa todas as imagens do bucket product-images</span>
              </div>
            </label>

            <label class="checkbox-option">
              <input type="checkbox" name="code" id="checkCode" value="1" />
              <div class="checkbox-content">
                <span class="checkbox-label">Código do Projeto</span>
                <span class="checkbox-description">Inclui package.json, .env.example, README.md e vercel.json</span>
              </div>
            </label>

            <label class="checkbox-option">
              <input type="checkbox" id="checkAll" />
              <div class="checkbox-content">
                <span class="checkbox-label">Tudo</span>
                <span class="checkbox-description">Inclui todos os componentes acima</span>
              </div>
            </label>
          </div>

          <div class="backup-actions">
            <button type="submit" id="generateBtn" class="btn-generate" disabled>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Gerar Backup
            </button>
          </div>
        </form>

        <!-- Progress Area -->
        <div id="progressArea" class="progress-area" style="display: none;">
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
          </div>
          <p id="progressText" class="progress-text">Preparando backup...</p>
        </div>
      </div>
    </div>

    <!-- Backups History -->
    <div class="section">
      <h2>Histórico de Backups</h2>
      {backups.length > 0 ? (
        <div class="backups-list">
          {backups.map((backup) => (
            <div class="backup-item">
              <div class="backup-info">
                <div class="backup-name">{backup.name}</div>
                <div class="backup-meta">
                  <span class="backup-size">{formatFileSize(backup.size)}</span>
                  <span class="backup-separator">•</span>
                  <span class="backup-date">{formatDate(backup.date)}</span>
                  <span class="backup-separator">•</span>
                  <span class="backup-components">{getBackupComponents(backup.name).join(', ')}</span>
                </div>
              </div>
              <a href={`/backups/${backup.name}`} download class="btn-download">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Baixar
              </a>
            </div>
          ))}
        </div>
      ) : (
        <div class="empty-state">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10 9 9 9 8 9"/>
          </svg>
          <p>Nenhum backup gerado ainda</p>
          <span>Gere seu primeiro backup usando as opções acima</span>
        </div>
      )}
    </div>
  </div>
</AdminLayout>

<style>
  .backup-page {
    max-width: 1200px;
  }

  .page-header {
    margin-bottom: 32px;
  }

  .page-header h1 {
    font-size: 1.8rem;
    margin-bottom: 8px;
  }

  .page-header p {
    color: var(--text-muted);
  }

  .section {
    margin-bottom: 40px;
  }

  .section h2 {
    font-size: 1.2rem;
    margin-bottom: 20px;
  }

  .backup-card {
    background: var(--primary);
    border-radius: var(--radius);
    padding: 24px;
    border: 1px solid var(--border);
  }

  .backup-options {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 24px;
  }

  .checkbox-option {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    cursor: pointer;
    padding: 12px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    transition: all 0.3s ease;
  }

  .checkbox-option:hover {
    border-color: var(--caramel);
    background: rgba(212, 165, 116, 0.05);
  }

  .checkbox-option input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-top: 2px;
    cursor: pointer;
    accent-color: var(--caramel);
  }

  .checkbox-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .checkbox-label {
    font-weight: 600;
    font-size: 1rem;
  }

  .checkbox-description {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .backup-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }

  .btn-generate {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--caramel);
    color: var(--bg-dark);
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-generate:hover:not(:disabled) {
    background: var(--caramel-dark);
  }

  .btn-generate:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .progress-area {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: var(--bg-card);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 12px;
  }

  .progress-fill {
    height: 100%;
    background: var(--caramel);
    transition: width 0.3s ease;
    border-radius: 4px;
  }

  .progress-text {
    font-size: 0.9rem;
    color: var(--text-muted);
    text-align: center;
  }

  .backups-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .backup-item {
    background: var(--primary);
    border-radius: var(--radius);
    padding: 20px 24px;
    border: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    transition: all 0.3s ease;
  }

  .backup-item:hover {
    border-color: var(--caramel);
  }

  .backup-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .backup-name {
    font-weight: 600;
    font-size: 1rem;
  }

  .backup-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .backup-separator {
    color: var(--border);
  }

  .backup-components {
    color: var(--caramel);
  }

  .btn-download {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--bg-card);
    color: var(--text);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-download:hover {
    background: var(--caramel);
    color: var(--bg-dark);
  }

  .empty-state {
    background: var(--primary);
    border-radius: var(--radius);
    padding: 48px 24px;
    border: 1px solid var(--border);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .empty-state svg {
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .empty-state p {
    font-weight: 600;
    font-size: 1.1rem;
  }

  .empty-state span {
    font-size: 0.9rem;
    color: var(--text-muted);
  }

  @media (max-width: 768px) {
    .backup-item {
      flex-direction: column;
      align-items: flex-start;
    }

    .btn-download {
      width: 100%;
      justify-content: center;
    }
  }
</style>

<script>
  // Checkboxes logic
  const checkDatabase = document.getElementById('checkDatabase');
  const checkStorage = document.getElementById('checkStorage');
  const checkCode = document.getElementById('checkCode');
  const checkAll = document.getElementById('checkAll');
  const generateBtn = document.getElementById('generateBtn');
  const backupForm = document.getElementById('backupForm');
  const progressArea = document.getElementById('progressArea');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');

  // Toggle all checkboxes
  checkAll?.addEventListener('change', function() {
    const isChecked = this.checked;
    checkDatabase.checked = isChecked;
    checkStorage.checked = isChecked;
    checkCode.checked = isChecked;
    updateGenerateButton();
  });

  // Update generate button state
  function updateGenerateButton() {
    const hasSelection = checkDatabase.checked || checkStorage.checked || checkCode.checked;
    generateBtn.disabled = !hasSelection;
  }

  checkDatabase?.addEventListener('change', updateGenerateButton);
  checkStorage?.addEventListener('change', updateGenerateButton);
  checkCode?.addEventListener('change', updateGenerateButton);

  // Update checkAll when individual checkboxes change
  [checkDatabase, checkStorage, checkCode].forEach(checkbox => {
    checkbox?.addEventListener('change', function() {
      checkAll.checked = checkDatabase.checked && checkStorage.checked && checkCode.checked;
    });
  });

  // Form submission
  backupForm?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    
    // Show progress
    progressArea.style.display = 'block';
    generateBtn.disabled = true;
    progressFill.style.width = '10%';
    progressText.textContent = 'Preparando backup...';

    try {
      // Call API
      const response = await fetch('/api/backup', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Erro ao criar backup');
      }

      // Update progress
      progressFill.style.width = '100%';
      progressText.textContent = 'Backup concluído! Recarregando página...';

      // Reload page after 1 second
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } catch (error: any) {
      progressText.textContent = 'Erro ao gerar backup: ' + (error.message || 'Erro desconhecido');
      generateBtn.disabled = false;
      progressArea.style.display = 'none';
    }
  });
</script>
